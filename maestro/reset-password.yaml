appId: ${APP_ID}
onFlowStart:
  - runScript: ./api.js
jsEngine: graaljs
---
# Reset Password Test Flow
# This test covers the complete password reset flow:
# 1. Generate reset link directly via admin API (no email checking needed)
# 2. Open reset link (deep link)
# 3. Enter new password
# 4. Verify success and sign in with new password
# 5. Reset password back to original for next test run
#
# Usage: maestro test -e APP_ID=com.etengenesis.langquest.preview reset-password.yaml
# The scheme will be automatically determined from APP_ID (e.g., langquest-preview://reset-password)

- evalScript: ${output.originalPassword = TEST_PASSWORD}
- evalScript: ${output.newPassword = "newpassword123"}

# Step 1: Generate reset link directly via admin API (no UI needed, no email checking)
# The function constructs the redirect URL in the same format as send-email
- evalScript: ${output.resetLink = output.api.generatePasswordResetLink(TEST_EMAIL)}

# Step 2: Launch app and open the reset link
- launchApp:
    clearState: true
- assertVisible: Terms & Privacy
- tapOn:
    point: 8%,86%
- tapOn: Accept
- assertVisible: Every language. Every culture.
- tapOn:
    point: 90%,16%
- openLink:
    link: ${output.resetLink}
    autoVerify: true

# Step 3: Enter new password on reset password screen
- assertVisible: Create New Password
- tapOn: New Password
- inputText: ${output.newPassword}
- tapOn: Confirm Password
- inputText: ${output.newPassword}
- hideKeyboard
# - tapOn: Update Password


# Step 4: Verify success alert
- assertVisible: Success
- tapOn: OK

# Step 5: Verify we're redirected to sign in, then sign in with new password
- tapOn:
    text: Sign In
    index: -1
- tapOn: Enter your email
- inputText: ${TEST_EMAIL}
- tapOn: Enter your password
- inputText: ${output.newPassword}
- hideKeyboard
- tapOn: Sign In
- assertVisible: My Projects

# Step 6: Reset password back to original for next test run
# Generate another reset link and reset to original password
- runScript: ./api.js
- evalScript: ${output.resetLink2 = output.api.generatePasswordResetLink(TEST_EMAIL)}
- openLink:
    link: ${output.resetLink2}
    autoVerify: true
- assertVisible: Create New Password
- tapOn: New Password
- inputText: ${output.originalPassword}
- tapOn: Confirm Password
- inputText: ${output.originalPassword}
- hideKeyboard
- tapOn: Update Password
- assertVisible: Success
- tapOn: OK
