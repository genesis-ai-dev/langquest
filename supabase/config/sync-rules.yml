config:
  edition: 2

streams:
  co_member_profiles:
    query: |
      SELECT * FROM profile
      WHERE id IN (
        SELECT profile_id FROM profile_project_link
        WHERE auth.user_id() in download_profiles
        AND active = true
      )
      AND active = true
    auto_subscribe: true

bucket_definitions:
  global_bucket:
    data:
      #   Sync all ui_ready languoids globally so they're available for project creation
      - SELECT * FROM "languoid" WHERE active = true AND ui_ready = true

  user_profile:
    parameters: SELECT request.user_id() AS profile_id
    data:
      # Sync the user's own profile
      - SELECT * FROM "profile" WHERE "profile".id = bucket.profile_id
      # Sync the user's project memberships
      - SELECT profile_id || '_' || project_id as id, * FROM "profile_project_link" WHERE "profile_project_link".profile_id = bucket.profile_id AND active = true

      # Co-member profiles are synced via the co_member_profiles sync stream
      - SELECT * FROM "project" WHERE bucket.profile_id in download_profiles
      - SELECT * FROM "quest" WHERE bucket.profile_id in download_profiles
      - SELECT * FROM "asset" WHERE bucket.profile_id in download_profiles
      - SELECT * FROM "asset_content_link" WHERE bucket.profile_id in download_profiles
      - SELECT project_id || '_' || languoid_id as id, * FROM "project_language_link" WHERE bucket.profile_id in download_profiles
      - SELECT asset_id || '_' || tag_id as id, * FROM "asset_tag_link" WHERE bucket.profile_id in download_profiles
      - SELECT * FROM "language" WHERE bucket.profile_id in download_profiles
      - SELECT quest_id || '_' || asset_id as id, * FROM "quest_asset_link" WHERE bucket.profile_id in download_profiles
      - SELECT quest_id || '_' || tag_id as id, * FROM "quest_tag_link" WHERE bucket.profile_id in download_profiles
      - SELECT * FROM "tag" WHERE bucket.profile_id in download_profiles
      - SELECT * FROM "vote" WHERE bucket.profile_id in download_profiles
      - SELECT profile_id || '_' || project_id as id, * FROM "profile_project_link" WHERE bucket.profile_id in download_profiles AND active = true

      # Sync languoids - using download_profiles directly (populated by bulk download function)
      - SELECT * FROM "languoid" WHERE bucket.profile_id in download_profiles

      # Sync languoid aliases - using download_profiles directly
      - SELECT * FROM "languoid_alias" WHERE bucket.profile_id in download_profiles

      # Sync languoid sources - using download_profiles directly
      - SELECT * FROM "languoid_source" WHERE bucket.profile_id in download_profiles

      # Sync languoid properties - using download_profiles directly
      - SELECT * FROM "languoid_property" WHERE bucket.profile_id in download_profiles

      # Sync languoid_region links - using download_profiles directly
      - SELECT * FROM "languoid_region" WHERE bucket.profile_id in download_profiles

      # Sync regions - using download_profiles directly
      - SELECT * FROM "region" WHERE bucket.profile_id in download_profiles

      # Sync region aliases - using download_profiles directly
      - SELECT * FROM "region_alias" WHERE bucket.profile_id in download_profiles

      # Sync region sources - using download_profiles directly
      - SELECT * FROM "region_source" WHERE bucket.profile_id in download_profiles

      # Sync region properties - using download_profiles directly
      - SELECT * FROM "region_property" WHERE bucket.profile_id in download_profiles

      - SELECT
        *
        FROM reports
        WHERE "reports".reporter_id = bucket.profile_id

      - SELECT
        blocker_id || '_' || blocked_id as id,
        *
        FROM blocked_users
        WHERE "blocked_users".blocker_id = bucket.profile_id

      - SELECT
        *
        FROM blocked_content
        WHERE "blocked_content".profile_id = bucket.profile_id

      - SELECT * FROM notification
        WHERE profile_id = bucket.profile_id

      # Sync languoid link suggestions for the user
      - SELECT * FROM languoid_link_suggestion
        WHERE profile_id = bucket.profile_id
        AND active = true

      - SELECT * FROM subscription
        WHERE profile_id = bucket.profile_id

      - SELECT * FROM invite
        WHERE (sender_profile_id = bucket.profile_id
        OR receiver_profile_id = bucket.profile_id)
        AND active = true

      - SELECT * FROM request
        WHERE sender_profile_id = bucket.profile_id
        AND active = true

  project_memberships:
    parameters: |
      SELECT project_id FROM profile_project_link
      WHERE profile_id = request.user_id()
        AND active = true
    data:
      # Sync project record for the project_id, this makes the my projects tab reactive to changes
      - SELECT * FROM project
        WHERE id = bucket.project_id

      - SELECT * FROM invite
        WHERE project_id = bucket.project_id

  project_ownerships:
    parameters: |
      SELECT project_id FROM profile_project_link
      WHERE profile_id = request.user_id()
        AND membership = 'owner'
        AND active = true
    data:
      - SELECT * FROM request
        WHERE project_id = bucket.project_id
