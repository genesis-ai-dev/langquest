name: Check Native Build Requirement

on:
  push:
    # REQUIRED: push dev branch is necessary for this action to update its fingerprint database
    branches: [dev]
  pull_request:
    types: [opened, synchronize]
  pull_request_review:
    types: [submitted]

jobs:
  fingerprint:
    if: github.event_name != 'pull_request_review'
    runs-on: ubuntu-latest
    # REQUIRED: limit concurrency when pushing dev branch to prevent conflict for this action to update its fingerprint database
    concurrency:
      group: fingerprint-${{ github.event_name != 'pull_request' && 'dev' || format('pr-{0}', github.event.pull_request.number) }}
      cancel-in-progress: ${{ github.event_name == 'pull_request' }}
    permissions:
      # REQUIRED: Allow comments of PRs
      pull-requests: write # Allow comments on PRs
      # REQUIRED: Allow updating fingerprint in action caches
      actions: write
      # OPTIONAL: Allow reading of repo contents for private projects
      # contents: read

    steps:
      - name: üèó Setup repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache-dependency-path: "**/package-lock.json"
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm install

      - name: Check fingerprint
        id: fingerprint
        uses: expo/expo-github-action/fingerprint@main
        with:
          packager: npm
          saving-db-branch: dev

      - name: "Add fingerprint changed label if not compatible"
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'dev' && steps.fingerprint.outputs.fingerprint-diff != '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['bot: fingerprint changed']
            })

      - name: "Remove fingerprint changed label if compatible"
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'dev' && steps.fingerprint.outputs.fingerprint-diff == '[]' }}
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'bot: fingerprint changed'
              })
            } catch (e) {
              if (e.status != 404) {
                throw e;
              }
            }

      - name: Write fingerprint diff to file
        if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'dev'
        run: |
          echo '${{ steps.fingerprint.outputs.fingerprint-diff }}' > fingerprint-diff-raw.json
        shell: bash

      - name: Check if fingerprint compatibility changed
        if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'dev'
        id: check-compatibility-change
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            // Read fingerprint diff from file to avoid environment variable size limits
            let fingerprintDiff = '[]';
            if (fs.existsSync('fingerprint-diff-raw.json')) {
              fingerprintDiff = fs.readFileSync('fingerprint-diff-raw.json', 'utf8').trim();
            }
            // Handle fingerprint diff - it's a JSON string, check if it's an empty array
            const trimmedDiff = String(fingerprintDiff).trim();
            // Empty array means no changes (compatible), non-empty means changes
            const hasChanges = trimmedDiff !== '[]' && trimmedDiff !== '';
            const isCompatible = trimmedDiff === '[]' || trimmedDiff === '';

            // Get existing reviews to check if we need to dismiss
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const existingReview = reviews.find(
              review => review.user.type === 'Bot' && review.user.login === 'github-actions[bot]' && review.state === 'CHANGES_REQUESTED'
            );

            // If fingerprint is now compatible (was changed, now compatible), dismiss the review
            // This happens automatically when fingerprint diff becomes [] (no changes)
            if (isCompatible && existingReview) {
              try {
                await github.rest.pulls.dismissReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  review_id: existingReview.id,
                  message: 'Fingerprint is now compatible - no native build required'
                });
                console.log('‚úÖ Dismissed review - fingerprint is now compatible');
              } catch (e) {
                // Silently continue if dismiss fails
                console.log('Could not dismiss review:', e.message);
              }
            }

            // Check if compatibility changed (had review before, now compatible OR no review before, now has changes)
            const hadReview = existingReview !== undefined;
            const compatibilityChanged = (hadReview && isCompatible) || (!hadReview && hasChanges);
            // Only create review if fingerprint changed AND no review exists yet
            // This allows manual approval/dismissal of the review when ready to merge
            const shouldCreateReview = hasChanges && !hadReview;

            core.setOutput('compatibility_changed', compatibilityChanged);
            core.setOutput('has_changes', hasChanges);
            core.setOutput('should_create_review', shouldCreateReview);
            core.setOutput('has_review', hadReview);

      - name: Request changes review if fingerprint changed
        if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'dev' && steps.check-compatibility-change.outputs.should_create_review == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = '‚ö†Ô∏è Native Build Required - See the comment below for details.';

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'REQUEST_CHANGES',
              body: message
            });

      - name: Format fingerprint diff for comment
        if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'dev' && steps.check-compatibility-change.outputs.has_changes == 'true'
        id: format-diff
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            // Read from file to avoid environment variable size limits
            let fingerprintDiffStr = '[]';
            if (fs.existsSync('fingerprint-diff-raw.json')) {
              fingerprintDiffStr = fs.readFileSync('fingerprint-diff-raw.json', 'utf8').trim();
            }
            // Parse the JSON string if it's valid JSON, otherwise use as-is
            let fingerprintDiff;
            try {
              fingerprintDiff = JSON.parse(fingerprintDiffStr);
            } catch (e) {
              fingerprintDiff = fingerprintDiffStr;
            }
            const prettifiedDiff = JSON.stringify(fingerprintDiff, null, 2);
            // Write to file to avoid output size limits
            fs.writeFileSync('fingerprint-diff.json', prettifiedDiff);
            // Set a flag output instead of the full diff
            core.setOutput('has_diff_file', 'true');

      - name: Comment on PR if fingerprint changed
        if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'dev' && steps.check-compatibility-change.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          HAS_DIFF_FILE: ${{ steps.format-diff.outputs.has_diff_file }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let prettifiedDiff = '[]';
            if (process.env.HAS_DIFF_FILE === 'true' && fs.existsSync('fingerprint-diff.json')) {
              prettifiedDiff = fs.readFileSync('fingerprint-diff.json', 'utf8');
            }
            
            const message = '<!-- fingerprint-check -->\n' +
              '‚ö†Ô∏è Native Build Required - Manual Approval Needed\n\n' +
              'This PR requires a native build because the fingerprint has changed compared to the base branch.\n\n' +
              '<details>\n' +
              '<summary>Fingerprint diff</summary>\n\n' +
              '```json\n' +
              prettifiedDiff + '\n' +
              '```\n\n' +
              '</details>\n\n' +
              'Action Required: After confirming with the team, another team member must approve this PR to proceed with merging.\n\n' +
              'üëâ [**Approve this PR**](' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/pull/' + context.issue.number + '/files) - Click "Review changes/Submit review" ‚Üí "Approve" to dismiss this review and allow merging.';

            // Find existing comment with fingerprint-check marker
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(
              comment => comment.user.type === 'Bot' && 
                         comment.user.login === 'github-actions[bot]' &&
                         comment.body.includes('<!-- fingerprint-check -->')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: message
              });
              console.log('‚úÖ Updated fingerprint comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
              console.log('‚úÖ Created fingerprint comment');
            }

      - name: Remove comment if fingerprint compatible
        if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'dev' && steps.check-compatibility-change.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Find and delete comments with the fingerprint-check marker
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const fingerprintComment = comments.find(
              comment => comment.user.type === 'Bot' && 
                         comment.user.login === 'github-actions[bot]' &&
                         comment.body.includes('<!-- fingerprint-check -->')
            );

            if (fingerprintComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: fingerprintComment.id,
              });
              console.log('‚úÖ Removed fingerprint comment');
            }

  dismiss-bot-review-on-approval:
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved' && github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Dismiss bot review after approval
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const botReview = reviews.find(
              review => review.user.login === 'github-actions[bot]' && review.state === 'CHANGES_REQUESTED'
            );

            if (!botReview) {
              core.info('No bot review to dismiss.');
              return;
            }

            await github.rest.pulls.dismissReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              review_id: botReview.id,
              message: 'PR approved - dismissing native build requirement review.'
            });
            core.info('Dismissed github-actions review after approval event.');
