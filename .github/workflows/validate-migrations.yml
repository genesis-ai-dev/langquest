name: Validate Migration History

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  check-paths:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should-run: ${{ steps.filter.outputs.migrations }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            migrations:
              - 'supabase/migrations/**/*.sql'
              - '.github/workflows/validate-migrations.yml'

  wait:
    runs-on: ubuntu-latest
    needs: [check-paths]
    if: ${{ needs.check-paths.outputs.should-run == 'true' }}
    permissions:
      checks: read
    outputs:
      status: ${{ steps.check.outputs.conclusion }}
    steps:
      - uses: fountainhead/action-wait-for-check@v1.2.0
        id: check
        with:
          checkName: Supabase Preview
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

  validate-migrations:
    needs: [check-paths, wait]
    if: ${{ needs.check-paths.outputs.should-run == 'true' && (needs.wait.result == 'success' && needs.wait.outputs.status == 'success') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PRODUCTION_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Get Branch Environment Variables
        run: |
          supabase --experimental branches get "$GITHUB_HEAD_REF" -o env >> $GITHUB_ENV
          # Mask JWT secret in logs immediately after retrieval
          if [ -n "$SUPABASE_JWT_SECRET" ]; then
            echo "::add-mask::${SUPABASE_JWT_SECRET}"
          fi

      - name: Get Migration History from Database
        id: db-migrations
        run: |
          # Check if POSTGRES_URL is set
          if [ -z "$POSTGRES_URL" ]; then
            echo "❌ POSTGRES_URL environment variable is not set"
            exit 1
          fi

          # Replace port 6543 with 5432 for direct Postgres connection
          # Remove all query parameters from the URL
          # Strip surrounding quotes if present (from env export)
          # Result: postgresql://postgres.project_ref:password@pooler-host:5432/postgres
          DB_URL=$(echo "$POSTGRES_URL" | sed "s|:6543|:5432|g" | sed 's|?.*||' | sed 's|^"||' | sed 's|"$||')

          # Mask password in logs for security
          DB_URL_MASKED=$(echo "$DB_URL" | sed 's|:[^:@]*@|:***@|g')
          echo "Using database URL: ${DB_URL_MASKED}"

          # Get migration history from database
          # The supabase_migrations.schema_migrations table stores applied migrations
          # Capture both stdout and stderr separately for better error reporting
          # Use the same approach as sync-rules workflow - pass URL directly to psql
          PSQL_ERROR=$(mktemp)
          DB_MIGRATIONS=$(psql "$DB_URL" -t -A -c "SELECT version || '_' || name FROM supabase_migrations.schema_migrations ORDER BY version;" 2>"$PSQL_ERROR" || echo "")
          PSQL_ERROR_CONTENT=$(cat "$PSQL_ERROR")
          rm -f "$PSQL_ERROR"

          if [ -z "$DB_MIGRATIONS" ]; then
            echo "⚠️  Could not query migration history from database"
            echo "This might mean migrations haven't been applied yet, or the database is not accessible"
            if [ -n "$PSQL_ERROR_CONTENT" ]; then
              echo "psql error: $PSQL_ERROR_CONTENT"
            fi
            echo "db_migrations=" >> $GITHUB_OUTPUT
          else
            echo "$DB_MIGRATIONS" > db_migrations.txt
            echo "✅ Retrieved migration history from database"
            echo "db_migrations<<EOF" >> $GITHUB_OUTPUT
            echo "$DB_MIGRATIONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Get Migration Files from Repository
        id: repo-migrations
        run: |
          # Get list of migration files from supabase/migrations directory
          # Format: timestamp_name.sql
          REPO_MIGRATIONS=$(find supabase/migrations -name "*.sql" -type f -exec basename {} \; | sed 's/\.sql$//' | sort)

          if [ -z "$REPO_MIGRATIONS" ]; then
            echo "❌ No migration files found in supabase/migrations"
            exit 1
          fi

          echo "$REPO_MIGRATIONS" > repo_migrations.txt
          echo "✅ Found migration files in repository"
          echo "repo_migrations<<EOF" >> $GITHUB_OUTPUT
          echo "$REPO_MIGRATIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Compare Migration History
        id: compare
        run: |
          # Install psql if not available
          if ! command -v psql &> /dev/null; then
            echo "Installing PostgreSQL client..."
            sudo apt-get update && sudo apt-get install -y postgresql-client
          fi

          # Read migration lists
          if [ -f db_migrations.txt ] && [ -f repo_migrations.txt ]; then
            DB_MIGRATIONS=$(cat db_migrations.txt)
            REPO_MIGRATIONS=$(cat repo_migrations.txt)
            
            echo "=== Migration History Comparison ==="
            echo ""
            echo "Migrations in database:"
            echo "$DB_MIGRATIONS" | head -10
            echo "..."
            echo ""
            echo "Migration files in repository:"
            echo "$REPO_MIGRATIONS" | head -10
            echo "..."
            echo ""
            
            # Convert to arrays for comparison
            # Note: DB format is "version_name", repo format is "timestamp_name"
            # We need to extract just the name part for comparison, or normalize formats
            
            # Extract just the migration names (without timestamp/version)
            DB_NAMES=$(echo "$DB_MIGRATIONS" | sed 's/^[0-9_]*_//' | sort)
            REPO_NAMES=$(echo "$REPO_MIGRATIONS" | sed 's/^[0-9_]*_//' | sort)
            
            # Find migrations in DB but not in repo
            MISSING_IN_REPO=$(comm -23 <(echo "$DB_NAMES") <(echo "$REPO_NAMES") || echo "")
            
            # Find migrations in repo but not in DB
            MISSING_IN_DB=$(comm -13 <(echo "$DB_NAMES") <(echo "$REPO_NAMES") || echo "")
            
            if [ -n "$MISSING_IN_REPO" ]; then
              echo "❌ CRITICAL: Migrations in database history but NOT in repository files:"
              echo "$MISSING_IN_REPO"
              echo ""
              echo "This means migration files were deleted but the migration history remains."
              echo "This will cause merge conflicts!"
              echo "comparison_status=failed" >> $GITHUB_OUTPUT
              echo "error_message=Migrations exist in database history but not in repository files" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            if [ -n "$MISSING_IN_DB" ]; then
              echo "⚠️  WARNING: Migration files exist in repository but not in database history:"
              echo "$MISSING_IN_DB"
              echo ""
              echo "These migrations may not have been applied yet."
              echo "comparison_status=warning" >> $GITHUB_OUTPUT
            fi
            
            if [ -z "$MISSING_IN_REPO" ] && [ -z "$MISSING_IN_DB" ]; then
              echo "✅ Migration history matches repository files!"
              echo "comparison_status=success" >> $GITHUB_OUTPUT
            else
              echo "comparison_status=warning" >> $GITHUB_OUTPUT
            fi
          else
            echo "⚠️  Could not compare migrations - missing migration lists"
            echo "comparison_status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: Remove PR comment if validation passed
        if: github.event_name == 'pull_request' && steps.compare.outputs.comparison_status == 'success'
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: migration-validation
          mode: delete

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.compare.outputs.comparison_status != 'success'
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## Migration History Validation

            ${{ steps.compare.outputs.comparison_status == 'failed' && '❌ **FAILED**' || '⚠️ **WARNING**' }}

            ${{ steps.compare.outputs.error_message || '' }}

            ${{ steps.compare.outputs.comparison_status == 'failed' && 'This PR has migrations in the database history that do not exist in the migration files. This will cause merge conflicts when merging to main.' || '' }}

            **Next steps:**
            - Review the migration history comparison above
            - Ensure all migrations in the database history have corresponding files in `supabase/migrations`
            - If migrations were intentionally deleted, you may need to repair the migration history
          comment-tag: migration-validation
